{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>FairHire</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet"
        type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="{% static 'css/styles.css' %}" rel="stylesheet" />

</head>

<body id="page-top">
    {% include "header.html" %}



    <!-- About Section-->
    <!-- <section class="page-section bg-primary text-white mb-0 " id="about"> -->
    <section class="page-section bg-white text-primary mb-0 " id="about" style="margin-top: 100px;">

        

    <div class="container chat border">
        <div class="row">
            <a href="{% url 'resolved_chat' id=context.chatroom.id %}">chat_resolved</a>
        </div>
        <div class="row">
            <div class="chat-messages col-md-8" id="messages">
                <!-- messages will be dynamically added here -->
            </div>
            <div class="col-md-12">
                <h4>Chat Information</h4>
                <p><strong>Requester:</strong> {{ context.chatroom.requester.email }}</p>
                <p><strong>Assigned To:</strong> {{ context.chatroom.assigned_to.email }}</p>
                <h4>Send a Message</h4>
                <form id="send-message-form" method="post" action="{% url 'chat_message' %}">
                    {% csrf_token %}
                    <input type="hidden" id="chat-room-id" name="chat_room_id" value="{{ context.chatroom.id }}">
                    <input type="hidden" id="sender-id" name="sender_id" value="{{ context.userid }}">
                    <div class="input-group mb-3">
                        <input type="text" id="message-input" name="message" class="form-control"
                            placeholder="Type your message...">
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>




        </div>
    </section>
    {% include "footer.html" %}
    <!-- Contact Section-->

    <!-- Footer-->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="{% static 'js/scripts.js' %}"></script>
    <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
    <!-- * *                               SB Forms JS                               * *-->
    <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
    <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
    <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
<script>

    $(function () {
            // get the CSRF token from the cookie and set it as a header for AJAX requests
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
            $.ajaxSetup({
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            // handle form submission to send message
            $('#send-message-form').submit(function (e) {
                e.preventDefault();
                const chatRoomId = $('#chat-room-id').val();
                const senderId = $('#sender-id').val();
                const message = $('#message-input').val();
                console.log(chatRoomId, senderId,message)
                if (message.trim() !== '') {
                    $.ajax({
                        url: $('#send-message-form').attr('action'),
                        type: 'POST',
                        data: {
                            'chat_room_id': chatRoomId,
                            'sender_id': senderId,
                            'message': message
                        },
                        success: function (response) {
                            // add the new message to the chat
                            const messageHtml = '<div class="chat-message"><span class="chat-sender">' + response.sender + '</span><span class="chat-text">' + response.message + '</span></div>';
                            $('.chat-messages').append(messageHtml);
                            // clear the message input field
                            $('#message-input').val('');
                        }
                    });
                }
            });
        });
        var lastMessageId = null;

           function updateMessages(chatRoomId) {
                $.get('/get_messages/' + chatRoomId, function (data) {
                    var messagesDiv = $('#messages');
                    messagesDiv.empty(); // clear the messages div
                    
                    var messages = data.messages;
                    for (var i = 0; i < messages.length; i++) {
                        var message = messages[i];
                        console.log(message.message)
                        messagesDiv.append('<div><strong>' + message.sender + '</strong>: ' + message.message + '</div>');
                    }
                });
            }

            setInterval(function () {
                var chatRoomId = $('#chat-room-id').val();
                updateMessages(chatRoomId);
            }, 2000);


</script>
</body>

</html>